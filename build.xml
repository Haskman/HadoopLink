<?xml version="1.0"?>

<project name="HadoopLink" basedir="." default="build">

  <property name="app.name" value="HadoopLink"/>
  <property name="version" value="0.1.0"/>

  <property name="build.dir" location="build"/>
  <property name="src.dir" location="src" />
  <property name="src.java.dir" location="${src.dir}/java"/>
  <property name="src.test.dir" location="${src.dir}/test"/>
  <property name="doc.src.dir" location="docs"/>
  <property name="classes.dir" location="${build.dir}/classes"/>
  <property name="log.dir" location="${basedir}/log"/>

  <target name="init">
    <tstamp/>

    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${classes.dir}"/>
    <mkdir dir="${log.dir}"/>

    <fail message="Please set the hadoop.home property to the path of your Hadoop installation.">
      <condition>
        <not><isset property="hadoop.home"/></not>
      </condition>
    </fail>

    <fail message="Please set the mathematica.dir property to the path of your Mathematica installation.">
      <condition>
        <not><isset property="mathematica.dir"/></not>
      </condition>
    </fail>

    <property name="jlink.jar" location="${mathematica.dir}/SystemFiles/Links/JLink/JLink.jar"/>
    <property name="mathExe" value="${mathematica.dir}/Contents/MacOS/MathKernel"/>

    <condition property="skip.docbuild">
      <not><isset property="workbench.dir"/></not>
    </condition>

    <!-- Load J/Link and set up the mathematica task type -->
    <taskdef name="mathematica" classname="com.wolfram.jlink.util.MathematicaTask"
      classpath="${jlink.jar}"/>

    <mathematica exe="${mathExe}">
      <![CDATA[

        AntSetProperty["user.app.dir", FileNameJoin[{$UserBaseDirectory, "Applications"}]];

        search[path_, form_] :=
          Module[
            {files, dirs},
            files = FileNames[form, {path}];
            If[ Length@files > 0,

              files,
              dirs = Select[FileNames["*", path], DirectoryQ];
              Flatten@Table[search[dir, form], {dir, dirs}]
            ]
          ];

          workbenchDir = AntProperty["workbench.dir"];
          If[ workbenchDir =!= Null,

            AntLog["Searching path "<>workbenchDir<>" for DocumentationBuild source."];
            paths = search[workbenchDir, "DocumentationBuild"];

            If[ Length@paths > 0,

              AntLog[paths[[1]]];

              AntSetProperty[
                "mathematica.app.dir",
                ParentDirectory[AbsoluteFileName@paths[[1]]]
              ];

            ]
          ];

      ]]>
    </mathematica>

    <path id="classpath">
      <fileset dir="${hadoop.home}">
        <include name="*.jar"/>
        <include name="lib/**/*.jar"/>
      </fileset>
      <pathelement location="${jlink.jar}"/>
    </path>
  </target>

  <target name="compile" depends="init" description="compile the source">
    <!-- Compile the java code from ${src.java} into ${build} -->
    <javac srcdir="${src.java.dir}" destdir="${classes.dir}"
      debug="${java.debug}" debuglevel="lines,vars,source">
      <classpath refid="classpath"/>
    </javac>
  </target>

  <target name="jar" depends="compile" description="package up Java components">
    <delete file="${build.dir}/${app.name}-${version}.jar"/>
    <jar jarfile="${build.dir}/${app.name}-${version}.jar">
      <fileset dir="${classes.dir}"/>
    </jar>
  </target>

  <target name="docbuild" depends="init" unless="skip.docbuild" description="">
    <!-- Check for the location of DocumentationBuild -->
    <fail message="Please set the mathematica.app.dir property to
      the path where the DocumentationBuild application is located">
      <condition>
        <not><isset property="mathematica.app.dir"/></not>
      </condition>
    </fail>

    <!-- Set up the properties expected by the doc build script -->
    <property name="appPath" value="${mathematica.app.dir}"/>
    <property name="mathematicaInstallDir" value="${mathematica.dir}"/>
    <property name="inputDir" value="${doc.src.dir}/English"/>
    <property name="outputDirNB" value="${basedir}/build/${app.name}/Documentation/English"/>
    <property name="logdir" value="${log.dir}"/>
    <property name="JLinkLoaded" value="true"/>
    <property name="jlink.lib" value="${jlink.jar}"/>

    <!-- call into documentation build scripts that ship with Mathematica -->
    <ant
      antfile="${appPath}/DocumentationBuild/SystemFiles/ant/Build/notebook.xml"
      target="main"/>
  </target>

  <target name="build" depends="jar" description="assemble all the components of the application">
    <mkdir dir="${build.dir}/${app.name}"/>
    <copy todir="${build.dir}/${app.name}">
      <fileset dir="${basedir}/${app.name}">
        <include name="**/*.m"/>
      </fileset>
    </copy>
    <copy todir="${build.dir}/${app.name}/Java"
      file="${build.dir}/${app.name}-${version}.jar"/>
  </target>

  <target name="package" depends="build,docbuild">
    <zip basedir="${build.dir}" destfile="${build.dir}/${app.name}-${version}.zip"
      includes="HadoopLink/**"/>
  </target>

  <target name="install" depends="package">
    <delete dir="${user.app.dir}/${app.name}"/>
    <unzip src="${build.dir}/${app.name}-${version}.zip" dest="${user.app.dir}"/>
  </target>

  <target name="clean" description="clean up">
    <!-- Delete the ${build} and ${dist} directory trees -->
    <delete dir="${build.dir}"/>
    <delete dir="${classes.dir}"/>
    <delete dir="${log.dir}"/>
    <delete dir="HadoopLink/Java"/>
  </target>
</project>
